// æ‰¾é¡¯ç¤ºç‹€æ…‹çš„åœ°æ–¹ï¼ˆä½ ç•«é¢æ˜¯ã€Œå°šæœªç™»å…¥ã€ï¼‰
const loginState = document.getElementById("loginState");
const roleState  = document.getElementById("roleState");
const gateMsg    = document.getElementById("gateMsg");
const debugMsg   = document.getElementById("debugMsg");

const appPanel   = document.getElementById("appPanel");
const adminPanel = document.getElementById("adminPanel");

const btnShot    = document.getElementById("btnShot");
const btnStart   = document.getElementById("btnStart");
const btnReroll  = document.getElementById("btnReroll");
const btnConfirm = document.getElementById("btnConfirm");

const shareTitle = document.getElementById("shareTitle");
const shareTime  = document.getElementById("shareTime");
const cardsBox   = document.getElementById("cards");
const userTip    = document.getElementById("userTip");

const myHistory   = document.getElementById("myHistory");
const chartLineEl = document.getElementById("chartLine");
const chartBarEl  = document.getElementById("chartBar");

// æ•™ç·´å¾Œå°
const addEmail       = document.getElementById("addEmail");
const removeEmail    = document.getElementById("removeEmail");
const btnAdd         = document.getElementById("btnAdd");
const btnRemove      = document.getElementById("btnRemove");
const adminMsg       = document.getElementById("adminMsg");
const studentSelect  = document.getElementById("studentSelect");
const btnLoadStudent = document.getElementById("btnLoadStudent");
const studentArea    = document.getElementById("studentArea");
const studentTitle   = document.getElementById("studentTitle");
const studentMeta    = document.getElementById("studentMeta");
const studentHistory = document.getElementById("studentHistory");
const chartLineStuEl = document.getElementById("chartLineStu");
const chartBarStuEl  = document.getElementById("chartBarStu");

// ====== ä½ å¯æ”¹çš„é›†åˆåç¨±ï¼ˆè·Ÿ Firestore ä¸€è‡´ï¼‰======
const ALLOWLIST_COL = "éœ¹é‚èˆ";   // å…è¨±åå–® collectionï¼ˆdocId = emailï¼‰
const COACH_COL     = "coaches";  // æ•™ç·´åå–® collectionï¼ˆdocId = email, role:"coach"ï¼‰
const RECORDS_ROOT  = "records";  // ç´€éŒ„æ ¹ collection

// ===== Auth (Popup + Redirect, works on iOS Safari) =====
await setPersistence(auth, browserLocalPersistence);
const provider = new GoogleAuthProvider();

const ua = navigator.userAgent || "";
const isIOS = /iPhone|iPad|iPod/i.test(ua);
const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

// redirect å›ä¾†ä¸€å®šè¦æ¥
try { await getRedirectResult(auth); } catch(e){
  if(e?.code) debugMsg.textContent = `redirect: ${e.code}`;
}

// ç™»å…¥ï¼šiOS Safari ç›´æ¥ redirectï¼›å…¶ä»–å…ˆ popup å¤±æ•—å† redirect
async function doLogin(){
  debugMsg.textContent = "";
  if(isIOS && isSafari){
    await signInWithRedirect(auth, provider);
    return;
  }
  try{
    await signInWithPopup(auth, provider);
  }catch(e){
    debugMsg.textContent = e?.code ? `popup: ${e.code} â†’ fallback redirect` : "popup å¤±æ•— â†’ æ”¹ç”¨ redirect";
    await signInWithRedirect(auth, provider);
  }
}
async function doLogout(){ debugMsg.textContent=""; await signOut(auth); }

btnLogin.addEventListener("click", doLogin);
btnLogout.addEventListener("click", doLogout);

// ===== Helpers =====
function allowDoc(email){ return doc(db, ALLOWLIST_COL, email); }
function coachDoc(email){ return doc(db, COACH_COL, email); }
function metaDoc(email){  return doc(db, RECORDS_ROOT, email, "meta", "state"); }
function itemsCol(email){ return collection(db, RECORDS_ROOT, email, "items"); }

function nowText(ts){ return new Date(ts).toLocaleString(); }

function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function signature(cards){
  return cards.map(c=>`${c.round}|${c.move}|${c.rule}`).join("||");
}

// ===== Training Pools =====
const fixedRounds = ["Top Rock","Go Down","Footwork","Set"];
const pool = {
  "Top Rock": ["Rock åŸºæœ¬å¾‹å‹•","æ–¹å‘è®ŠåŒ–","å±¤æ¬¡åˆ‡æ›","ç¯€å¥æ–·é»","æ‰‹è‡‚ç·šæ¢"],
  "Go Down":  ["ä¹¾æ·¨è½åœ°","æ§åˆ¶é‡å¿ƒ","çªç„¶ä¸‹é™","åœ°æ¿åˆ‡å…¥","å‡å‹•ä½œè½åœ°"],
  "Footwork": ["ç¯€å¥è…³æ­¥","è§’åº¦è½‰æ›","è¿‘èº«æ»‘å‹•","åŠ é€Ÿçˆ†é»","é€£æ¥æµæš¢"],
  "Set":      ["Freeze å®šé»","Power é€£æ¥","å‡ power","è§’åº¦ pose","å‘¼å¸åœé “"]
};
const rules = ["éŸ³æ¨‚è¡¨ç¾","è³ªåœ°å‘ˆç¾","é€Ÿåº¦å·®å‘ˆç¾","ä¿æŒç§»å‹•","ç©ºé–“é‹ç”¨","è§’åº¦è®ŠåŒ–","å‘¼å¸æ§åˆ¶","ä¹¾æ·¨åº¦"];

// ===== State =====
let currentUser=null, isAllowed=false, isCoach=false;
let preview=null;
let chartLine=null, chartBar=null, chartLineStu=null, chartBarStu=null;

// ===== UI =====
function setUI(){
  if(!currentUser){
    loginState.textContent="å°šæœªç™»å…¥";
    appPanel.style.display="none";
    adminPanel.style.display="none";
    gateMsg.textContent="";
    roleState.textContent="";
    return;
  }
  loginState.textContent=`å·²ç™»å…¥ï¼š${currentUser.email||""}`;

  if(!isAllowed){
    appPanel.style.display="none";
    adminPanel.style.display="none";
    gateMsg.textContent="ä½ ä¸åœ¨å…è¨±åå–®å…§ï¼ˆè«‹æ•™ç·´æŠŠä½ çš„ email åŠ å…¥åå–®ï¼‰";
    return;
  }

  gateMsg.textContent="";
  appPanel.style.display="block";
  userTip.textContent=`ä½¿ç”¨è€…ï¼š${currentUser.email}`;

  adminPanel.style.display = isCoach ? "block" : "none";
  roleState.textContent = isCoach ? "ï¼ˆæ•™ç·´ï¼‰" : "";
}

// ===== Gate Check =====
async function checkGate(user){
  isAllowed=false; isCoach=false;
  if(!user?.email) return;

  const email=user.email.toLowerCase();

  const aSnap=await getDoc(allowDoc(email));
  isAllowed = aSnap.exists();

  const cSnap=await getDoc(coachDoc(email));
  isCoach = cSnap.exists() && (cSnap.data()?.role==="coach");
}

// ===== Ratings bind =====
function bindRanges(){
  const bind=(rid,sid)=>{
    const r=document.getElementById(rid);
    const s=document.getElementById(sid);
    const fn=()=>{ s.textContent=String(r.value); };
    r.addEventListener("input",fn); fn();
  };
  bind("r_music","s_music");
  bind("r_texture","s_texture");
  bind("r_speed","s_speed");
  bind("r_move","s_move");
  bind("r_overall","s_overall");
}
bindRanges();

function getRatings(){
  const v=(id)=>Number(document.getElementById(id).value);
  return {
    music:v("r_music"),
    texture:v("r_texture"),
    speed:v("r_speed"),
    move:v("r_move"),
    overall:v("r_overall")
  };
}

// ===== Preview + Avoid last confirmed =====
async function getLastSig(email){
  const snap=await getDoc(metaDoc(email));
  return snap.exists() ? (snap.data()?.lastSig||"") : "";
}
async function setLastSig(email,sig){
  await setDoc(metaDoc(email), { lastSig:sig }, { merge:true });
}

function renderCards(cards){
  cardsBox.innerHTML="";
  cards.forEach((c,idx)=>{
    const el=document.createElement("div");
    el.className="card";
    el.innerHTML=`
      <div class="card-inner">
        <div class="face back">CLICK</div>
        <div class="face front">
          <div class="round">Round ${idx+1} Â· ${c.round}</div>
          <div class="move">${c.move}</div>
          <div class="rule">è¦å‰‡ï¼š${c.rule}</div>
        </div>
      </div>`;
    el.addEventListener("click",()=>el.classList.toggle("flip"));
    cardsBox.appendChild(el);
  });
}

async function makePreview(){
  if(!currentUser?.email) return;
  const email=currentUser.email.toLowerCase();
  const lastSig=await getLastSig(email);

  let tries=0, cards=null, sig="";
  while(tries<12){
    tries++;
    const cardsTry=fixedRounds.map(round=>({
      round,
      move:shuffle(pool[round])[0],
      rule:shuffle(rules)[0]
    }));
    sig=signature(cardsTry);
    if(sig!==lastSig){ cards=cardsTry; break; }
  }
  if(!cards){
    cards=fixedRounds.map(round=>({
      round,
      move:shuffle(pool[round])[0],
      rule:shuffle(rules)[0]
    }));
    sig=signature(cards);
  }

  const ts=Date.now();
  preview={ ts, cards, sig };

  shareTitle.textContent=`BATTLE TRAINING Â· ${currentUser.email}`;
  shareTime.textContent=`é è¦½æ™‚é–“ï¼š${nowText(ts)}`;
  renderCards(cards);

  btnReroll.disabled=false;
  btnConfirm.disabled=false;
  btnShot.disabled=false;
}

btnStart.addEventListener("click", makePreview);
btnReroll.addEventListener("click", makePreview);

// ===== Confirm record =====
async function confirmRecord(){
  if(!currentUser?.email || !preview) return;

  btnConfirm.disabled=true;

  const email=currentUser.email.toLowerCase();
  const ts=Date.now();
  const ratings=getRatings();

  const docData={
    ts, email,
    cards:preview.cards,
    sig:preview.sig,
    ratings
  };

  await addDoc(itemsCol(email), docData);
  await setLastSig(email, preview.sig);

  shareTime.textContent=`âœ… å·²ç¢ºèªï¼š${nowText(ts)}`;
  await loadMyHistory();

  btnConfirm.disabled=false;
}
btnConfirm.addEventListener("click", confirmRecord);

// ===== History + Charts =====
function renderHistory(listEl, items){
  listEl.innerHTML="";
  if(items.length===0){
    const div=document.createElement("div");
    div.className="pill";
    div.innerHTML=`<div class="muted">å°šç„¡ç´€éŒ„</div>`;
    listEl.appendChild(div);
    return;
  }
  items.forEach(it=>{
    const r=it.ratings||{};
    const div=document.createElement("div");
    div.className="pill";
    div.innerHTML=`
      <b>${new Date(it.ts).toLocaleString()}</b>
      <div class="muted">æ•´é«”ï¼š${r.overall??"-"}ï½œéŸ³æ¨‚ï¼š${r.music??"-"}ï½œè³ªåœ°ï¼š${r.texture??"-"}ï½œé€Ÿåº¦å·®ï¼š${r.speed??"-"}ï½œä¿æŒç§»å‹•ï¼š${r.move??"-"}</div>`;
    listEl.appendChild(div);
  });
}

function avg(items,key){
  if(items.length===0) return 0;
  const s=items.reduce((a,it)=>a+Number(it.ratings?.[key]||0),0);
  return s/items.length;
}

function drawCharts(lineCanvas, barCanvas, items, holder){
  const labels=items.map(it=>new Date(it.ts).toLocaleDateString());
  const overall=items.map(it=>Number(it.ratings?.overall||0));

  const barLabels=["éŸ³æ¨‚æ€§","è³ªåœ°","é€Ÿåº¦å·®","ä¿æŒç§»å‹•","æ•´é«”"];
  const barData=[
    avg(items,"music"),
    avg(items,"texture"),
    avg(items,"speed"),
    avg(items,"move"),
    avg(items,"overall")
  ];

  if(holder.line) holder.line.destroy();
  if(holder.bar) holder.bar.destroy();

  holder.line=new Chart(lineCanvas,{
    type:"line",
    data:{ labels, datasets:[{ label:"æ•´é«”åˆ†", data:overall }] },
    options:{ responsive:true, scales:{ y:{ min:0, max:5, ticks:{ stepSize:1 } } } }
  });

  holder.bar=new Chart(barCanvas,{
    type:"bar",
    data:{ labels:barLabels, datasets:[{ label:"å¹³å‡åˆ†", data:barData }] },
    options:{ responsive:true, scales:{ y:{ min:0, max:5, ticks:{ stepSize:1 } } } }
  });
}

async function loadHistory(email){
  const qy=query(itemsCol(email), orderBy("ts","desc"), limit(10));
  const snap=await getDocs(qy);
  const items=[];
  snap.forEach(d=>items.push(d.data()));
  return items;
}

async function loadMyHistory(){
  if(!currentUser?.email) return;
  const email=currentUser.email.toLowerCase();
  const items=await loadHistory(email);

  renderHistory(myHistory, items);

  const ordered=[...items].reverse();
  drawCharts(chartLineEl, chartBarEl, ordered, {
    get line(){return chartLine}, set line(v){chartLine=v},
    get bar(){return chartBar}, set bar(v){chartBar=v}
  });
}

// ===== Coach: list + add/remove + student charts =====
async function refreshStudentSelect(){
  if(!isCoach) return;
  studentSelect.innerHTML=`<option value="">ï¼ˆé¸æ“‡å­¸ç”Ÿï¼‰</option>`;

  const snap=await getDocs(collection(db, ALLOWLIST_COL));
  const emails=[];
  snap.forEach(d=>{
    const id=(d.id||"").toLowerCase();
    if(id) emails.push(id);
  });
  emails.sort();
  emails.forEach(e=>{
    const opt=document.createElement("option");
    opt.value=e; opt.textContent=e;
    studentSelect.appendChild(opt);
  });
}

async function adminAdd(){
  if(!isCoach) return;
  const email=(addEmail.value||"").trim().toLowerCase();
  if(!email.includes("@")){ adminMsg.textContent="è«‹è¼¸å…¥æ­£ç¢º email"; return; }
  await setDoc(allowDoc(email), { role:"student", updatedAt:Date.now() }, { merge:true });
  adminMsg.textContent=`âœ… å·²æ–°å¢ï¼š${email}`;
  addEmail.value="";
  await refreshStudentSelect();
}
async function adminRemove(){
  if(!isCoach) return;
  const email=(removeEmail.value||"").trim().toLowerCase();
  if(!email.includes("@")){ adminMsg.textContent="è«‹è¼¸å…¥æ­£ç¢º email"; return; }
  await deleteDoc(allowDoc(email));
  adminMsg.textContent=`ğŸ—‘ï¸ å·²ç§»é™¤ï¼š${email}`;
  removeEmail.value="";
  await refreshStudentSelect();
}

async function loadStudent(){
  if(!isCoach) return;
  const email=(studentSelect.value||"").trim().toLowerCase();
  if(!email){ adminMsg.textContent="è«‹å…ˆé¸å­¸ç”Ÿ"; return; }

  const items=await loadHistory(email);
  studentArea.style.display="block";
  studentTitle.textContent=email;
  studentMeta.textContent=`æœ€è¿‘ ${items.length} ç­†ï¼ˆåªåŒ…å«ç¢ºèªç´€éŒ„ï¼‰`;

  renderHistory(studentHistory, items);

  const ordered=[...items].reverse();
  drawCharts(chartLineStuEl, chartBarStuEl, ordered, {
    get line(){return chartLineStu}, set line(v){chartLineStu=v},
    get bar(){return chartBarStu}, set bar(v){chartBarStu=v}
  });
}

btnAdd.addEventListener("click", adminAdd);
btnRemove.addEventListener("click", adminRemove);
btnLoadStudent.addEventListener("click", loadStudent);

// ===== Export Image =====
async function exportImage(){
  const area=document.getElementById("shareArea");
  btnShot.disabled=true;
  const canvas=await html2canvas(area,{ backgroundColor:null, scale:2 });
  const a=document.createElement("a");
  a.download=`battle_training_${Date.now()}.png`;
  a.href=canvas.toDataURL("image/png");
  a.click();
  btnShot.disabled=false;
}
btnShot.addEventListener("click", exportImage);

// ===== Auth state (æ ¸å¿ƒ) =====
onAuthStateChanged(auth, async (user)=>{
  currentUser=user||null;

  // reset
  preview=null;
  cardsBox.innerHTML="";
  btnReroll.disabled=true;
  btnConfirm.disabled=true;
  btnShot.disabled=true;
  shareTitle.textContent="â€”";
  shareTime.textContent="â€”";
  gateMsg.textContent="";
  roleState.textContent="";

  if(!currentUser){
    isAllowed=false; isCoach=false;
    setUI();
    return;
  }

  try{
    await checkGate(currentUser);
    setUI();

    if(isAllowed) await loadMyHistory();
    if(isCoach) await refreshStudentSelect();
  }catch(e){
    debugMsg.textContent = e?.code ? `gate: ${e.code}` : "è®€å–æ¬Šé™/è³‡æ–™éŒ¯èª¤ï¼ˆé€šå¸¸æ˜¯ Firestore rules æ“‹ä½ï¼‰";
    isAllowed=false; isCoach=false;
    setUI();
  }
});
