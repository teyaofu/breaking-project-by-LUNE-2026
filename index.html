<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login Test</title>
<style>
  body{margin:0;font-family:Arial;background:#0b0b12;color:#fff}
  .wrap{max-width:820px;margin:auto;padding:16px}
  .box{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
  button{padding:12px 14px;border:0;border-radius:12px;font-weight:900;cursor:pointer}
  .p{background:linear-gradient(135deg,#ff00c8,#00f5ff);color:#000}
  .g{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.14)}
  pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10)}
</style>
</head>
<body>
<div class="wrap">
  <h2>Firebase Google 登入測試</h2>
  <div class="box">
    <p>這頁只測「登入」是否能成功跳轉回來。成功後我再把完整工具版貼回去。</p>
    <button id="login" class="p">Google 登入</button>
    <button id="logout" class="g">登出</button>
    <p><b>狀態：</b><span id="state">尚未登入</span></p>
    <p><b>訊息：</b></p>
    <pre id="msg">（等待操作）</pre>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider,
    signInWithRedirect, getRedirectResult,
    signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqwvRJEEPPvT0-PUY9bTTwbikD9mI21XQ",
    authDomain: "breaking-814bf.firebaseapp.com",
    projectId: "breaking-814bf",
    storageBucket: "breaking-814bf.firebasestorage.app",
    messagingSenderId: "1061448738181",
    appId: "1:1061448738181:web:29ce05df24b74bdf15d0ec",
    measurementId: "G-7KD2654Y69"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const $ = (id)=>document.getElementById(id);
  const log = (t)=>{ $("msg").textContent = t; };

  // 重要：iOS/手機用 redirect、桌機用 popup
  $("login").onclick = async ()=>{
    try{
      log("開始登入…（若跳轉到 Google 是正常）");
      const provider = new GoogleAuthProvider();
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      if(isMobile){
        await signInWithRedirect(auth, provider);
        return;
      }else{
        await signInWithPopup(auth, provider);
        log("Popup 登入完成，等待狀態更新…");
      }
    }catch(e){
      log("登入觸發失敗：\n" + (e?.code||"") + "\n" + (e?.message||""));
      alert("登入失敗：\n" + (e?.code||"") + "\n" + (e?.message||""));
      console.error(e);
    }
  };

  $("logout").onclick = async ()=>{
    await signOut(auth);
    log("已登出");
  };

  // redirect 回來後一定會跑這段（抓錯誤碼最關鍵）
  getRedirectResult(auth).then((res)=>{
    if(res?.user){
      log("Redirect 回來成功：\n" + res.user.email);
    }else{
      log("Redirect 結果：沒有使用者（可能尚未登入或被阻擋）");
    }
  }).catch((e)=>{
    log("Redirect 回來失敗：\n" + (e?.code||"") + "\n" + (e?.message||""));
    alert("Redirect 失敗：\n" + (e?.code||"") + "\n" + (e?.message||""));
    console.error(e);
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      $("state").textContent = "✅ 已登入：" + user.email;
    }else{
      $("state").textContent = "尚未登入";
    }
  });

  // 額外資訊（幫你判斷是不是網址/瀏覽器問題）
  log(
    "UserAgent:\n" + navigator.userAgent +
    "\n\nOrigin:\n" + location.origin +
    "\n\nHref:\n" + location.href +
    "\n\n請按『Google 登入』後，把跳出的錯誤碼貼給我。"
  );
</script>
</body>
</html>
